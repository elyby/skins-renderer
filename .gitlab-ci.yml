stages:
  - Tests
  - Build
  - Release

variables:
  CONTAINER_IMAGE: "registry.ely.by/elyby/skins-renderer-service"

PHP-CS-Fixer:
  image: edbizarro/gitlab-ci-pipeline-php:7.2-alpine
  stage: Tests
  cache:
    key: vendor
    paths:
      - vendor
  before_script:
    - composer install --ignore-platform-reqs
  script:
    - vendor/bin/php-cs-fixer fix -v --dry-run

PHPUnit:
  image: edbizarro/gitlab-ci-pipeline-php:7.2-alpine
  stage: Tests
  cache:
    key: vendor
    paths:
      - vendor
  before_script:
    - composer install --ignore-platform-reqs
  script:
    - vendor/bin/phpunit --coverage-text


Build Docker image:
  image: docker:18.02
  stage: Build
  before_script:
    - docker login -u gitlab-ci -p $CI_BUILD_TOKEN registry.ely.by
  script:
    - export IMAGE_NAME="$CONTAINER_IMAGE:latest"
    - docker build --pull --build-arg "build_env=prod" -t $IMAGE_NAME .
  only:
    - master
    - tags

Release :latest tag:
  image: docker:18.02
  stage: Release
  variables:
    GIT_STRATEGY: none
  before_script:
    - docker login -u gitlab-ci -p $CI_BUILD_TOKEN registry.ely.by
  script:
    - docker push $CONTAINER_IMAGE:latest
  only:
    - master
    - tags
